<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YT-DLP Video İndirici</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Video İndirici</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flashes">
                    {% for category, message in messages %}
                        <li class="{{ category }}">{{ message }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <form action="/download" method="post">
            <label for="video_url">Video URL:</label>
            <input type="text" id="video_url" name="video_url" placeholder="Video URL'sini buraya yapıştırın" required>
            <button type="submit">İndirmeyi Başlat</button>
        </form>

        <div id="status-display">
            <!-- İndirme durumu ve linki buraya gelecek -->
            {% if session_id %}
                <p>İndirme başlatıldı. Durum takip ediliyor...</p>
                <div id="progress-bar-container">
                    <div id="progress-bar"></div>
                </div>
                <p id="progress-text">0%</p>
                <p id="download-link-container"></p> {# İndirme linki için p etiketi #}
                <p id="error-message" class="error-text"></p>
                <script>
                    // Flask'tan gelen session_id'yi JavaScript'e aktar
                    const currentSessionId = "{{ session_id }}";
                </script>
            {% endif %}
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Hüseyin Uygur | <a href="https://github.com/huseyinuygur/video_indirici" target="_blank">Kaynak Kodu</a></p>
    </footer>

    <script>
        // JavaScript sadece session_id varsa çalışacak
        if (typeof currentSessionId !== 'undefined' && currentSessionId !== '') {
            const statusDisplay = document.getElementById('status-display');
            const progressBarContainer = document.getElementById('progress-bar-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const downloadLinkContainer = document.getElementById('download-link-container'); // Geri getirildi
            const errorMessage = document.getElementById('error-message');

            let pollInterval;

            function checkDownloadStatus() {
                fetch(`/status/${currentSessionId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Durum verisi:', data);
                        if (data.status === 'pending' || data.status === 'downloading' || data.status === 'processing') {
                            // İndirme devam ediyor veya işleniyor
                            progressBarContainer.style.display = 'block';
                            progressBar.style.width = data.progress || '0%';
                            progressText.textContent = data.progress || '0%';
                            statusDisplay.innerHTML = `<p>İndirme durumu: ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}...</p>`;
                            if (data.progress) {
                                statusDisplay.innerHTML += `<p>İlerleme: ${data.progress}</p>`;
                            }
                        } else if (data.status === 'completed') {
                            // İndirme tamamlandı
                            clearInterval(pollInterval); // Sorgulamayı durdur
                            progressBarContainer.style.display = 'none';
                            progressText.style.display = 'none';
                            statusDisplay.innerHTML = '<p>Video hazır! Oynatmak/İndirmek için tıklayın:</p>'; // Mesaj değişti
                            
                            // Düğmeyi tekrar oluştur
                            downloadLinkContainer.innerHTML = `<a href="${data.download_link}" class="download-button" target="_blank">Videoyu Oynat/İndir (${data.original_filename || 'video.mp4'})</a>`;
                            downloadLinkContainer.style.display = 'block'; // Görünür yap
                            
                            errorMessage.textContent = ''; // Hata mesajını temizle
                            
                            // Otomatik indirme satırı kaldırıldı:
                            // if (data.download_link) {
                            //     window.location.href = data.download_link;
                            // }

                        } else if (data.status === 'failed') {
                            // İndirme başarısız oldu
                            clearInterval(pollInterval); // Sorgulamayı durdur
                            progressBarContainer.style.display = 'none';
                            progressText.style.display = 'none';
                            statusDisplay.innerHTML = '<p>İndirme başarısız oldu.</p>';
                            errorMessage.textContent = `Hata: ${data.error}`;
                            errorMessage.style.display = 'block';
                            downloadLinkContainer.innerHTML = ''; // İndirme linkini temizle
                            downloadLinkContainer.style.display = 'none'; // Gizle
                        } else if (data.status === 'not_found') {
                            // İndirme bulunamadı (belki session ID yanlış veya süre doldu)
                            clearInterval(pollInterval);
                            statusDisplay.innerHTML = '<p>İndirme durumu bulunamadı veya süresi doldu.</p>';
                            errorMessage.textContent = data.error;
                            errorMessage.style.display = 'block';
                            progressBarContainer.style.display = 'none';
                            progressText.style.display = 'none';
                            downloadLinkContainer.innerHTML = '';
                            downloadLinkContainer.style.display = 'none'; // Gizle
                        }
                    })
                    .catch(error => {
                        console.error('Durum sorgulanırken hata:', error);
                        clearInterval(pollInterval);
                        statusDisplay.innerHTML = '<p>Durum sorgulanırken bir hata oluştu.</p>';
                        errorMessage.textContent = `Ağ Hatası: ${error.message}`;
                        errorMessage.style.display = 'block';
                        progressBarContainer.style.display = 'none';
                        progressText.style.display = 'none';
                        downloadLinkContainer.innerHTML = '';
                        downloadLinkContainer.style.display = 'none'; // Gizle
                    });
            }

            // Sayfa yüklendiğinde ve her 3 saniyede bir durumu sorgula
            pollInterval = setInterval(checkDownloadStatus, 3000); // Her 3 saniyede bir sorgula
            checkDownloadStatus(); // Sayfa yüklendiğinde ilk sorgulamayı yap
        }
    </script>
</body>
</html>
